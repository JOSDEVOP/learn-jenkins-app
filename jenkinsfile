pipeline{
    
    agent any
    stages{
         
        stage('Build'){
           
            agent{
                docker{
                    image 'node:18-alpine'
                    args '-u root'
                    reuseNode true
                }
            }
          
            steps{
                
    //    cleanWs()
        //  chown -R $(id -u):$(id -g) ~/.npm   
         //   npm ci --unsafe-perm
                sh'''
          
               npm ci --unsafe-perm

                pwd
                ls -la
                npm --version
                node --version
           

                npm run build
                ls -la
                
                '''
                
            }
        }
        stage('Test'){
            agent{
                docker{
                    image 'node:18-alpine'
                    reuseNode true
            
                } 
                

            }
                steps{
                      sh'''
                    test  -f  build/index.html
                    npm test

                '''
                archiveArtifacts artifacts:'test-results/**'
                }
            
        }
        stage('E2E'){
            agent{
                docker{
                    image 'mcr.microsoft.com/playwright:v1.46.1-jammy'
                    reuseNode true
                    args' -u root'
            
                } 
                

            }
                steps{
                      sh'''
                      npm install   -g serve
                      serve -s build
                      npx playwright test

                '''
      
                }
            
        }
        
        
    }
 
    post{
success{

    archiveArtifacts artifacts: 'build/**'
}

    }
  
}
