pipeline{
    
    agent any
    stages{
         
        stage('Build'){
           
            agent{
                docker{
                    image 'node:20-alpine'
                    // args '-u root'
                    reuseNode true
                }
            }
          
            steps{
                
    //    cleanWs()
     
         //   npm ci --unsafe-perm
                
                 sh '''
                # Adjust file permissions to allow the Docker user to modify the workspace files
                chown -R $(id -u):$(id -g) .
                chmod -R 755 .
                
                pwd
                ls -la
                npm --version
                node --version
                npm ci
                npm run build
                
                ls -la
                '''
                
            }
        }
        stage('Test'){
            agent{
                docker{
                    image 'node:20-alpine'
                    reuseNode true
            
                } 
                

            }
                steps{
                      sh'''
                    test  -f  build/index.html
                    npm test

                '''
                archiveArtifacts artifacts:'test-results/**'
                }
            
        }
        stage('E2E'){
            agent{
                docker{
                    image 'mcr.microsoft.com/playwright:v1.46.1-jammy'
                    reuseNode true
                    // args' -u root'
            
                } 
                

            }
                steps{
                      sh''' 
                 
                      npm install   serve
                      node_modules/.bin/serve -s build
                      npx playwright test

                '''
      
                }
            
        }
        
        
    }
 
    post{
success{

    archiveArtifacts artifacts: 'build/**'
}

    }
  
}
